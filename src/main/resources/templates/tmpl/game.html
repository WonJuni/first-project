<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>총알 피하기 게임</title>
    <style>
        canvas {
            border: 1px solid black;
            display: block;
            margin: 0 auto;
        }
    </style>

</head>

<body>
    <canvas id="gameCanvas"></canvas>
    <div id="timer">시간: 0</div>
    <script>
        let gameOver = false;
        let playing = false;
        let canvas = document.querySelector('#gameCanvas');
        let ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 800;

        let gameTimer; // 게임 타이머 변수
        let seconds = 0; // 초 카운터 변수

        let keysDown = {};
        let startDown = {};

        let humanX = canvas.width / 2 - 32;
        let humanY = canvas.height / 2;
        let humanImage
        let shootImage
        let gameOverImage

        let interval;

        function loadImage() {
            humanImage = new Image();
            humanImage.src = "./../imgs/human.png";
            shootImage = new Image();
            shootImage.src = "./../imgs/bullet2.png";

        }
        gameOverImage = new Image();
        gameOverImage.src = "./../imgs/gameover.jpg";



        function update() {
            if (39 in keysDown && 38 in keysDown) {
                // 오른쪽 + 위
                humanX += 2.5;
                humanY -= 2.5;
            } else if (39 in keysDown && 40 in keysDown) {
                // 오른쪽 + 아래
                humanX += 2.5;
                humanY += 2.5;
            } else if (37 in keysDown && 38 in keysDown) {
                // 왼쪽 + 위
                humanX -= 2.5;
                humanY -= 2.5;
            } else if (37 in keysDown && 40 in keysDown) {
                // 왼쪽 + 아래
                humanX -= 2.5;
                humanY += 2.5;
            } else if (39 in keysDown) {
                // 오른쪽
                humanX += 5;
            } else if (37 in keysDown) {
                // 왼쪽
                humanX -= 5;
            } else if (40 in keysDown) {
                // 아래
                humanY += 5;
            } else if (38 in keysDown) {
                // 위
                humanY -= 5;
            }


            for (let i = 0; i < shootList.length; i++) {
                shootList[i].update();
            }
        }
        function render() {

            // 캔버스를 클리어
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 사람 이미지 그리기
            ctx.drawImage(humanImage, humanX, humanY, 30, 30);

            // 발사체 이미지 그리기
            for (let i = 0; i < shootList.length; i++) {
                ctx.drawImage(shootImage, shootList[i].x, shootList[i].y, 20, 20);
            }
        }

        function animation() {
            if (!gameOver) {
                update();
                render();
                requestAnimationFrame(animation);
            } else {
                ctx.drawImage(gameOverImage, 10, 10, 800, 400);
                startButtonListener();
            }
        }



        function setupKeyboardListener() {
            document.addEventListener("keydown", function (event) {
                keysDown[event.keyCode] = true;

            });

            document.addEventListener("keyup", function (event) {
                delete keysDown[event.keyCode];
            });
        }

        function generateRandomValue(min, max) {
            let randomNum = Math.floor(Math.random() * (max - min + 1)) + min
            return randomNum;
        }

        let shootList = [];

        function shoot() {
            this.x = 0;
            this.y = 0;
            let randomDirection = Math.floor(Math.random() * 3);
            let randomPosition = Math.floor(Math.random() * 2);
            //위
            if (randomPosition == 0) {
                this.init = function () {
                    this.y = 0;
                    this.x = generateRandomValue(0, canvas.width - 48)
                    shootList.push(this);
                };
            }
            //아래
            if (randomPosition == 1) {
                this.init = function () {
                    this.y = canvas.height;
                    this.x = generateRandomValue(0, canvas.width - 48)
                    shootList.push(this);
                };
            }

            this.update = function () {
                //직선
                if (randomDirection == 0 && randomPosition == 0) {
                    this.y += 3;
                }
                if (randomDirection == 0 && randomPosition == 1) {
                    this.y -= 3;
                }
                //왼쪽에서 오른쪽
                if (randomDirection == 1 && randomPosition == 0) {
                    this.y += 3;
                    this.x += 3;
                }
                if (randomDirection == 1 && randomPosition == 1) {
                    this.y -= 3;
                    this.x += 3;
                }
                //오른쪽에서 왼쪽
                if (randomDirection == 2 && randomPosition == 0) {
                    this.y += 3;
                    this.x -= 3;
                }
                if (randomDirection == 2 && randomPosition == 1) {
                    this.y -= 3;
                    this.x -= 3;
                }
                if (
                    this.x < humanX + 30 &&  //30은 휴면의 사진 크기 20은 총알의 크기
                    this.x + 20 > humanX &&
                    this.y < humanY + 30 &&
                    this.y + 20 > humanY
                ) {
                    gameOver = true;
                    playing = false;
                    alert(`게임종료, 버틴시간 :  + ${seconds}`);
                    clearInterval(gameTimer);
                }
            }
        };

        function createshoot() {
            interval = setInterval(function () {
                let e = new shoot()
                e.init()
            }, 100)
        }

        function main() {
            loadImage();
            setupKeyboardListener();
            animation();
            gameTimer = setInterval(updateTimer, 1000);
            createshoot();
        }

        function updateTimer() {
            // 초 카운터를 1씩 증가
            seconds++;

            // 화면에 시간을 업데이트
            document.querySelector('#timer').textContent = `시간: ${seconds}`;
        }


        function startButtonListener() {
            document.addEventListener("keydown", function (event) {
                if (event.keyCode == 32 && !playing) {
                    playing = true;
                    gameOver = false;
                    // 캔버스를 클리어
                    clearInterval(interval)
                    seconds = 0;
                    keysDown = {};
                    shootList = [];
                    humanX = canvas.width / 2 - 32;
                    humanY = canvas.height / 2;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    main();
                }
            });
        }

        startButtonListener();




    </script>
</body>

</html>