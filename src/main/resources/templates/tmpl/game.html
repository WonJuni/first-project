<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>총알 피하기 게임</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        
        canvas {
            border: 1px solid black;
            display: block;
            margin: 0 auto;
            background-image: url("[[${#httpServletRequest.contextPath}]]/imgs/screen1.jpg");

        }

        body {
            background-color: black;
            /* 애니메이션 효과 설정 */
        }

        #timer {
            color: white;
            border: 3px;
            font-family:'DotGothic16', sans-serif;;
            font-size: 40px;
            text-align: center;
        }
        #press{
            color: white;
            border: 3px;
            font-family:'DotGothic16', sans-serif;;
            font-size: 40px;
            text-align: center;
        }
    </style>
        <audio id="bgm" preload="auto">
            <source th:src="@{/bgm/game.mp3}" type="audio/mpeg">
            </audio>
   
   
</head>

    <canvas id="gameCanvas"></canvas>

    <body>
    <div id="timer">Press the Spacebar</div>
    <div id="press"></div>
    <script>
        let gameOver = false;
        let playing = false;
        let bgm = document.getElementById("bgm");
        let canvas = document.querySelector('#gameCanvas');
        let ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 800;


        let gameTimer; // 게임 타이머 변수
        let seconds = 0; // 초 카운터 변수

        let keysDown = {};
        let startDown = {};

        let humanX = canvas.width / 2 - 32;
        let humanY = canvas.height / 2;
        let humanImage
        let shootImage
        let gameOverImage
        let boomImage

        let interval;
 
        function loadImage() {
            humanImage = new Image();
            humanImage.src = "./../imgs/UFO.png";
            shootImage = new Image();
            shootImage.src = "./../imgs/meteo.png";
            gameOverImage = new Image();
            gameOverImage.src = "./../imgs/game-over1.png";
            boomImage = new Image();
            boomImage.src = "./../imgs/boom.png";
        }




        function update() {
            if (39 in keysDown && 38 in keysDown) {
                // 오른쪽 + 위
                humanX += 5;
                humanY -= 5;
            } else if (39 in keysDown && 40 in keysDown) {
                // 오른쪽 + 아래
                humanX += 5;
                humanY += 5;
            } else if (37 in keysDown && 38 in keysDown) {
                // 왼쪽 + 위
                humanX -= 5;
                humanY -= 5;
            } else if (37 in keysDown && 40 in keysDown) {
                // 왼쪽 + 아래
                humanX -= 5;
                humanY += 5;
            } else if (39 in keysDown) {
                // 오른쪽
                humanX += 5;
            } else if (37 in keysDown) {
                // 왼쪽
                humanX -= 5;
            } else if (40 in keysDown) {
                // 아래
                humanY += 5;
            } else if (38 in keysDown) {
                // 위
                humanY -= 5;
            }


            for (let i = 0; i < shootList.length; i++) {
                shootList[i].update();
            }
        }
        function render() {

            // 캔버스를 클리어
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 사람 이미지 그리기
            ctx.drawImage(humanImage, humanX, humanY, 30, 30);

            // 발사체 이미지 그리기
            for (let i = 0; i < shootList.length; i++) {
                ctx.drawImage(shootImage, shootList[i].x, shootList[i].y, 20, 20);
            }
        }

        function animation() {
            if (!gameOver) {
                update();
                render();
                requestAnimationFrame(animation);
            } else {
                ctx.drawImage(boomImage,humanX - 15,humanY - 15,50,50);
                document.querySelector('#press').innerHTML = 'press the Spacebar';
                startButtonListener();
            }
        }



        function setupKeyboardListener() {
            document.addEventListener("keydown", function (event) {
                keysDown[event.keyCode] = true;

            });

            document.addEventListener("keyup", function (event) {
                delete keysDown[event.keyCode];
            });
        }

        function generateRandomValue(min, max) {
            let randomNum = Math.floor(Math.random() * (max - min + 1)) + min
            return randomNum;
        }

        let shootList = [];

        function shoot() {
            this.x = 0;
            this.y = 0;
            let randomDirection = Math.floor(Math.random() * 3);
            let randomPosition = Math.floor(Math.random() * 2);
            //위
            if (randomPosition == 0) {
                this.init = function () {
                    this.y = 0;
                    this.x = generateRandomValue(0, canvas.width - 48)
                    shootList.push(this);
                };
            }
            //아래
            if (randomPosition == 1) {
                this.init = function () {
                    this.y = canvas.height;
                    this.x = generateRandomValue(0, canvas.width - 48)
                    shootList.push(this);
                };
            }

            this.update = function () {
                //직선
                if (randomDirection == 0 && randomPosition == 0) {
                    this.y += 5;
                }
                if (randomDirection == 0 && randomPosition == 1) {
                    this.y -= 5;
                }
                //왼쪽에서 오른쪽
                if (randomDirection == 1 && randomPosition == 0) {
                    this.y += 5;
                    this.x += 5;
                }
                if (randomDirection == 1 && randomPosition == 1) {
                    this.y -= 5;
                    this.x += 5;
                }
                //오른쪽에서 왼쪽
                if (randomDirection == 2 && randomPosition == 0) {
                    this.y += 5;
                    this.x -= 5;
                }
                if (randomDirection == 2 && randomPosition == 1) {
                    this.y -= 5;
                    this.x -= 5;
                }
                if (
                    this.x < humanX + 15 &&  //30은 휴면의 사진 크기 20은 총알의 크기
                    this.x + 10 > humanX &&
                    this.y < humanY + 15 &&
                    this.y + 10 > humanY
                ) {
                    
                    gameOver = true;
                    bgm.pause();
                    playing = false;
                    
                    clearInterval(gameTimer);
                }
            }
        };

        function createshoot() {
            interval = setInterval(function () {
                let e = new shoot()
                e.init()
            }, 100)
        }

        function main() {
            bgm.play();
            loadImage();
            animation();
            setupKeyboardListener();
            gameTimer = setInterval(updateTimer, 1000);
            createshoot();
        }

        function updateTimer() {
            // 초 카운터를 1씩 증가
            seconds++;

            // 화면에 시간을 업데이트
            document.querySelector('#timer').textContent = `Alive Time: ${seconds}`;
        }


        function startButtonListener() {
            document.addEventListener("keydown", function (event) {
                if (event.keyCode == 32 && !playing) {        
                    playing =true;         
                    gameOver = false; 
                    document.querySelector('#press').innerHTML='';         
                    clearInterval(interval)
                    seconds = 0;
                    keysDown = {};
                    shootList = [];
                    humanX = canvas.width / 2 - 32;
                    humanY = canvas.height / 2;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    main();
                }
            });
        }
     
        startButtonListener();





    </script>
</body>

</html>